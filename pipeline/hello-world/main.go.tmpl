package main

import (
	"fmt"
	"context"

	"github.com/open-integration/core"
	"github.com/open-integration/core/pkg/event"
	"github.com/open-integration/core/pkg/event/reporter"
	"github.com/open-integration/core/pkg/state"
	"github.com/open-integration/core/pkg/task"
)

func main() {
	pipe := core.Pipeline{
		Metadata: core.PipelineMetadata{
			Name: "{{ .metadata.name }}",
		},
		Spec: core.PipelineSpec{
			Services: []core.Service{
			{{ range .services }}
				core.Service{
					As:      "{{ .as }}",
					Name:    "{{ .name }}",
					Version: "{{ .version }}",
				},
			{{ end }}
			},
			Reactions: []core.EventReaction{
				{{ range $i, $eventReaction := .eventReactions -}}
					{
						Condition: {{ BuildCondition .condition }},
						Reaction: func(ev event.Event, state state.State) []task.Task {
                        	return []task.Task{
								{{ range $eventReaction.reactions -}}
								core.NewFunctionTask("{{ BuildTaskFunction .name  }}", Run{{ BuildTaskRunner .name }}),
								{{ end }}
                        	}
						},
					},
				{{- end }}
			},
		},
	}
	e := core.NewEngine(&core.EngineOptions{
		Pipeline: pipe,
	})
	core.HandleEngineError(e.Run())
}

{{ range $i, $eventReaction := .eventReactions }}
{{ range $eventReaction.reactions -}}


func Run{{ BuildTaskRunner .name }}(ctx context.Context, options task.RunOptions) ([]byte, error) {
	fmt.Println("*****************")
	fmt.Println("Hello World")
	fmt.Println("*****************")
	return []byte{}, nil
}

{{ end }}
{{ end }}